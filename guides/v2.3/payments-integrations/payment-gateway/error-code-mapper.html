<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width initial-scale=1" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<title>错误码映射 | Magento 2 Developer Documentation</title>
	<meta name="description" content="Magento 2 Developer Documentation.
">

	<link rel="stylesheet" href="/assets/css/app.css" />
	<link rel="stylesheet" href="/assets/css/print.css" media="print"/>

	<link rel="stylesheet" href="/common/css/devdocs.css" />

	<script>
  var baseUrl = "";
  var algolia = {
    id : "E642SEDTHL",
    index:  "devdocs",
    key:  "d2d0f33ab73e291ef8d88d8b565e754c"
  };
</script>




	<link rel="canonical" href="http://localhost:4000/guides/v2.3/payments-integrations/payment-gateway/error-code-mapper.html">

	<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="https://magento.com/favicon.ico">
	<link rel="apple-touch-icon" type="image/png" href="https://magento.com/apple-touch-icon.png">
	<link rel="apple-touch-icon" type="image/png" sizes="57x57" href="https://magento.com/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" type="image/png" sizes="72x72" href="https://magento.com/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://magento.com/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" type="image/png" sizes="114x114" href="https://magento.com/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://magento.com/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="https://magento.com/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://magento.com/apple-touch-icon-152x152.png">
	<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://magento.com/apple-touch-icon-180x180.png">

</head>
<body class="layout-default">

	<header class="site-header">

		<nav class="site-nav">

  <div class="menu-btn">
    <a id="menu-btn" class="menu-trigger menu-icon" href="#nav-main" aria-haspopup="true" aria-controls="nav-main"></a>
  </div>

  <div class="nav-container">

    <a class="logo" href="/guides/v2.3/">
      <img src="/assets/i/m-logo.svg" alt=""><img src="/assets/i/magento-logo.svg" alt="Magento" class="magento-logo" />
      <span class="site-logo">DevDocs</span>
    </a>

    <div id="nav-main" class="nav-main-wrap" aria-labelledby="menu-btn">
      
<div class="version-switcher dropdown" data-version="2.3">
	<button id="version-switcher-button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Magento 2.3 Pre-release
	</button>

	<ul class="dropdown-menu dropdown-menu-left" aria-labelledby="version-switcher-button">
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.0/payments-integrations/payment-gateway/error-code-mapper.html">Magento 2.0</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.1/payments-integrations/payment-gateway/error-code-mapper.html">Magento 2.1</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.2/payments-integrations/payment-gateway/error-code-mapper.html">Magento 2.2</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.3/payments-integrations/payment-gateway/error-code-mapper.html">Magento 2.3 Pre-release</a></li>
	
  </ul>

</div>


      <!-- Main Navigation -->
<ul class="nav-main" role="menubar">

  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">部署</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
          <li><a href="/guides/v2.3/install-gde/bk-install-guide.html">安装向导</a></li>
          
          <li><a href="/guides/v2.3/config-guide/bk-config-guide.html">配置手册</a></li>
          
          <li><a href="/guides/v2.3/performance-best-practices/index.html">高效实践</a></li>
          
          <li><a href="/guides/v2.3/migration/bk-migration-guide.html">迁移指引</a></li>
          <li><a href="/guides/v2.3/cloud/bk-cloud.html">上云指引</a></li>
          <li><a href="/magento-release-information.html">版本日志</a></li>
      </ul>
    </div>

  </li>


  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">开发</span>

    <div class="nav-popup" role="menu" aria-hidden="true">

      <div class="nav-section">
        <div class="nav-section-title">服务端</div>
        <ul>
          <li><a href="/guides/v2.3/architecture/bk-architecture.html">架构说明</a></li>
          <li><a href="/guides/v2.3/extension-dev-guide/bk-extension-dev-guide.html">PHP开发文档</a></li>
          <li><a href="/guides/v2.3/ext-best-practices/bk-ext-best-practices.html">扩展开发实践</a></li>
          <li><a href="/guides/v2.3/mrg/intro.html">各模块介绍</a></li>
          <li><a href="/guides/v2.3/coding-standards/bk-coding-standards.html">编码规范</a></li>
          <li><a href="/guides/v2.3/contributor-guide/contributing.html">贡献指引</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">前端</div>
        <ul>
          <li class=""><a href="/guides/v2.3/frontend-dev-guide/bk-frontend-dev-guide.html">前端工程师手册</a></li>
          
          <li><a href="/guides/v2.3/ui_comp_guide/bk-ui_comps.html">UI组件手册</a></li>
          
          <li><a href="/guides/v2.3/javascript-dev-guide/bk-javascript-dev-guide.html">JavaScript开发手册</a></li>
          <li><a href="/guides/v2.3/pattern-library/bk-pattern.html">管理面板设计模式及所用库</a></li>
          <li><a href="/guides/v2.3/design-styleguide/bk-styleguide.html">管理面板样式手册</a></li>
          <li><a href="https://magento-research.github.io/pwa-devdocs/">PWA Studios</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-section-title"><abbr>API</abbr></div>
        <ul>
          <li><a href="/guides/v2.3/get-started/bk-get-started-api.html">Web APIs起步</a></li>
          <li><a href="/guides/v2.3/rest/bk-rest.html">REST API参考</a></li>
          <li><a href="/guides/v2.3/soap/bk-soap.html">SOAP API参考</a></li>
          
          <li><a href="/guides/v2.3/graphql/index.html">GraphQL开发者手册(新!)</a></li>
          
          
          <li><a href="/guides/v2.3/marketplace/eqp/api.html">Marketplace EQP API Reference</a></li>
          
        </ul>
      </div>
    </div>

  </li>


  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">测试</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
        <li><a href="/guides/v2.3/test/testing.html">Magento测试手册</a></li>
        
        <li><a href="/guides/v2.3/magento-functional-testing-framework/release-2/introduction.html">功能验收测试(新!)</a></li>
        
        <li><a href="/guides/v2.3/mtf/mtf_introduction.html">功能测试</a></li>
        <li><a href="/guides/v2.3/test/integration/integration_test_execution.html">集成测试</a></li>
        <li><a href="/guides/v2.3/test/js/jasmine.html">JavaScript单元测试</a></li>
        <li><a href="/guides/v2.3/test/unit/unit_test_execution.html">PHP单元测试</a></li>
        <li><a href="/guides/v2.3/get-started/web-api-functional-testing.html">Web API功能测试</a></li>
      </ul>
    </div>

  </li>


  <li class="nav-main-separator"></li>


  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">功能文档</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
          
          <li class="leaf"><a href="/guides/v2.3/advanced-reporting/overview.html">高级报表</a></li>
          
        
        <li class="leaf"><a href="/guides/v2.3/b2b/bk-b2b.html">B2B</a></li>
        
        <li><a href="/guides/v2.3/howdoi/checkout/checkout_overview.html">Checkout</a></li>
        <li><a href="/guides/v2.3/payments-integrations/bk-payments-integrations.html">支付集成</a></li>
        
          <li><a href="/guides/v2.3/extension-dev-guide/staging.html">Staging</a></li>
        
      </ul>
    </div>

  </li>


  <li class="nav-main-item"  tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">指引</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
        <li><a href="/guides/v2.3/howdoi/bk-how-do-i.html">如何</a></li>
        
        <li><a  data-proofer-ignore href="/guides/v2.3/get-started/order-tutorial/order-intro.html">使用EST APIs处理订单</a></li>
        

        <li><a href="/videos/">视频教程</a></li>
      </ul>
    </div>

  </li>

</ul><!-- /.nav-main -->

    </div>

    <div class="search-btn">
      <a class="search-trigger search-icon" href="#"></a>
    </div>

    <form class="quick-search" action="/guides/v2.3/search.html" method="get" novalidate="novalidate">
      <input type="search" name="q" placeholder="Search" />
      <a href="#" class="quick-search-close">&times;</a>
    </form>

  </div>

</nav><!-- #site-nav -->
<div class="nav-main-fader"></div>


	</header>

	<div class="global-wrapper">

		<div class="main-container">
			<a id="main-content"></a>


<div class="content-container">

	<!-- sidebar -->
<aside class="sidebar">
	<a href="#" data-proofer-ignore class="toc-toggler">内容表格</a>
	<div class="sidebar-wrapper">

		

		<h4 class="guide-title">支付提供商网关</h4>
		<div class="collapsible-navigation">
		    <ul>
		    
		    	

<li class="nav-level1  " id="介绍">
    

    
    <a href="/guides/v2.3/payments-integrations/bk-payments-integrations.html">介绍</a>
    

    
</li>


		    
		    	

<li class="nav-level1  " id="magento支付提供商网关">
    

    
    <a href="/guides/v2.3/payments-integrations/payment-gateway/payment-gateway-intro.html">Magento支付提供商网关</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="支付提供商网关结构">

            

            
            <a href="/guides/v2.3/payments-integrations/payment-gateway/payment-gateway-structure.html">支付提供商网关结构</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="网关命令">

            

            
            <a href="/guides/v2.3/payments-integrations/payment-gateway/gateway-command.html">网关命令</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="网关命令池">

            

            
            <a href="/guides/v2.3/payments-integrations/payment-gateway/command-pool.html">网关命令池</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="请求构造器">

            

            
            <a href="/guides/v2.3/payments-integrations/payment-gateway/request-builder.html">请求构造器</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="网关客户端">

            

            
            <a href="/guides/v2.3/payments-integrations/payment-gateway/gateway-client.html">网关客户端</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="响应校验器">

            

            
            <a href="/guides/v2.3/payments-integrations/payment-gateway/response-validator.html">响应校验器</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="响应处理器">

            

            
            <a href="/guides/v2.3/payments-integrations/payment-gateway/response-handler.html">响应处理器</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2 active " id="错误码映射">

            

            
            <a href="/guides/v2.3/payments-integrations/payment-gateway/error-code-mapper.html">错误码映射</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="添加一个新的支付集成(支付方式)">
    

    
    <a href="/guides/v2.3/payments-integrations/base-integration/integration-intro.html">添加一个新的支付集成(支付方式)</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="支集模块配置">

            

            
            <a href="/guides/v2.3/payments-integrations/base-integration/module-configuration.html">支集模块配置</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="支集方式配置">

            

            
            <a href="/guides/v2.3/payments-integrations/base-integration/payment-option-config.html">支集方式配置</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="支集方式外观接口">

            

            
            <a href="/guides/v2.3/payments-integrations/base-integration/facade-configuration.html">支集方式外观接口</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="管理面板的支付信息渲染">

            

            
            <a href="/guides/v2.3/payments-integrations/base-integration/formblocktype.html">管理面板的支付信息渲染</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="添加支付动作">

            

            
            <a href="/guides/v2.3/payments-integrations/base-integration/payment-action.html">添加支付动作</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="从前台获取支付信息到后台">

            

            
            <a href="/guides/v2.3/payments-integrations/base-integration/get-payment-info.html">从前台获取支付信息到后台</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="根据地区配置支付方法">

            

            
            <a href="/guides/v2.3/payments-integrations/base-integration/admin-integration.html">根据地区配置支付方法</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="添加vault集成">
    

    
    <a href="/guides/v2.3/payments-integrations/vault/vault-intro.html">添加vault集成</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="添加vault到模块依赖">

            

            
            <a href="/guides/v2.3/payments-integrations/vault/module-configuration.html">添加vault到模块依赖</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="vault支付配置">

            

            
            <a href="/guides/v2.3/payments-integrations/vault/vault-payment-configuration.html">vault支付配置</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="vault依赖注入配置">

            

            
            <a href="/guides/v2.3/payments-integrations/vault/vault-di.html">vault依赖注入配置</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="启用vault">

            

            
            <a href="/guides/v2.3/payments-integrations/vault/enabler.html">启用vault</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="支付令牌">

            

            
            <a href="/guides/v2.3/payments-integrations/vault/payment-token.html">支付令牌</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="token-ui-component-provider">

            

            
            <a href="/guides/v2.3/payments-integrations/vault/token-ui-component-provider.html">令牌UI组件提供器</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="显示存储的信息">

            

            
            <a href="/guides/v2.3/payments-integrations/vault/customer-stored-payments.html">显示存储的信息</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="vault管理面板实现">

            

            
            <a href="/guides/v2.3/payments-integrations/vault/admin-integration.html">vault管理面板实现</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="signifyd欺诈保护">
    

    
    <a href="/guides/v2.3/payments-integrations/signifyd/signifyd.html">Signifyd欺诈保护</a>
    

    
</li>


		    
		    </ul>
		</div>

	</div>

</aside>
<!-- /sidebar -->


	<section class="content">
		<div class="content-wrap">
			<!-- page-header -->
<section class="page-intro">
	

  <nav class="breadcrumbs">

    <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      <li class="breadcrumb-item"><a class="breadcrumb-item" href="/guides/v2.3/"><span>首页</span></a></li>

    <!-- Iteration breadcrumb item -->
    
    

    

      <!-- Skip if root -->
      

      <!-- Get breadcrumb title -->
      

      <!-- SEO data -->
      

      <li class="breadcrumb-item active" property="itemListElement" typeof="ListItem">

        

          

          <span property="name">错误码映射</span>

        

        <meta property="position" content="1" />
      </li>

    

    </ol>

  </nav>



	

	

	<h1 class="page-heading">错误码映射</h1>

  


</section>

			<p>A payment gateway has error codes or messages that need to be transformed to user-friendly messages. When an error occurs, Magento  delivers the message to the appropriate audience so that the customer or merchant can resolve any problems. You can set up each payment integration to map the native error codes and messages into sets of text strings. As a result, you can ensure that only the proper audience (merchants only, customers only, or all) sees each error message. By default, the standard error message (<code class="highlighter-rouge">An error occurred on the server. Please try to place the order again.</code>) displays if a payment operation fails and a specific mapped message cannot be found.</p>

<p>Magento provides the <a href="https://github.com/magento/magento2/blob/2.3-develop/app/code/Magento/Payment/Gateway/ErrorMapper/ErrorMessageMapperInterface.php"><code class="highlighter-rouge">\Magento\Payment\Gateway\ErrorMapper\ErrorMessageMapperInterface</code></a> interface and default mapper implementation at <a href="https://github.com/magento/magento2/blob/2.3-develop/app/code/Magento/Payment/Gateway/ErrorMapper/ErrorMessageMapper.php"><code class="highlighter-rouge">\Magento\Payment\Gateway\ErrorMapper\ErrorMessageMapper</code></a> to enable customizations.</p>

<p>This topic uses examples based on the Magento Braintree payment integration to illustrate how to enable error code mapping.</p>

<h2 id="implement-mapping-files">Implement mapping files</h2>

<p>In most cases, you must define one or more mapping files and configure the default implementation of <code class="highlighter-rouge">ErrorMessageMapperInterface</code> using the module’s <code class="highlighter-rouge">di.xml</code> file. Alternatively, you can implement a programmatic solution described in <a href="#retrieve-errors">Retrieve error codes from the response validator</a>.</p>

<h3 id="map-the-messages">Map the messages</h3>

<p>The first step is to create one or more XML files that map message codes to messages. Magento recommends naming these files <code class="highlighter-rouge">&lt;gateway_name&gt;_error_mapping.xml</code>, but you can use any name you like. If you create more than one mapping file, each file must have the same file name. Use the following table to determine where to place mapping files:</p>

<table>
  <thead>
    <tr>
      <th>Audience</th>
      <th>location</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>All users</td>
      <td><code class="highlighter-rouge">&lt;module&gt;/etc</code></td>
    </tr>
    <tr>
      <td>Merchants</td>
      <td><code class="highlighter-rouge">&lt;module&gt;/adminhtml</code></td>
    </tr>
    <tr>
      <td>Customers</td>
      <td><code class="highlighter-rouge">&lt;module&gt;/frontend</code></td>
    </tr>
  </tbody>
</table>

<p>The files placed in the <code class="highlighter-rouge">adminhtml</code> and <code class="highlighter-rouge">frontend</code> directories ensure that customers and store administrators see only audience-specific messages. For example, a customer should see error messages when a credit card fails verfication due to mis-entered data and similar reasons. The store’s administrator should have more detailed descriptions of why an attempt to create an invoice or refund failed.</p>

<p>The  <a href="https://github.com/magento/magento2/blob/2.3-develop/app/code/Magento/Braintree/etc/braintree_error_mapping.xml">braintree_error_mapping.xml</a> file provides an example  collection:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;mapping</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">"urn:magento:module:Magento_Payment:etc/error_mapping.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;message_list&gt;</span>
        <span class="nt">&lt;message</span> <span class="na">code=</span><span class="s">"81703"</span> <span class="na">translate=</span><span class="s">"true"</span><span class="nt">&gt;</span>Credit card type is not accepted by this merchant account.<span class="nt">&lt;/message&gt;</span>
        <span class="nt">&lt;message</span> <span class="na">code=</span><span class="s">"81706"</span> <span class="na">translate=</span><span class="s">"true"</span><span class="nt">&gt;</span>CVV is required.<span class="nt">&lt;/message&gt;</span>
        <span class="nt">&lt;message</span> <span class="na">code=</span><span class="s">"81707"</span> <span class="na">translate=</span><span class="s">"true"</span><span class="nt">&gt;</span>CVV must be 4 digits for American Express and 3 digits for other card types.<span class="nt">&lt;/message&gt;</span>
        ...
    <span class="nt">&lt;/message_list&gt;</span>
<span class="nt">&lt;/mapping&gt;</span>
</code></pre></div></div>

<p>The message definitions are based on the <a href="https://github.com/magento/magento2/blob/2.3-develop/app/code/Magento/Payment/etc/error_mapping.xsd">error_mapping.xsd</a> schema. Messages must comply with the following structure:</p>

<ul>
  <li><code class="highlighter-rouge">message_list</code> — the root node. It can contain a list of specific messages</li>
  <li><code class="highlighter-rouge">message</code> — the node, which contains the customized message and two attributes
    <ul>
      <li><code class="highlighter-rouge">code</code> — the error code returned from the payment gateway. The value can be numeric or string</li>
      <li><code class="highlighter-rouge">translate</code> — a boolean attribute that determines whether to collect all message translations</li>
    </ul>
  </li>
</ul>

<h3 id="configure-dependency-injection">Configure dependency injection</h3>

<p>After you map the messages, you must specify the location of the error mapping file or files for the config reader. To do this, create a <code class="highlighter-rouge">virtualType</code> defintion for <code class="highlighter-rouge">\Magento\Payment\Gateway\ErrorMapper\VirtualConfigReader</code> in the module’s <code class="highlighter-rouge">di.xml</code> file:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;virtualType</span> <span class="na">name=</span><span class="s">"Magento\Braintree\Gateway\ErrorMapper\VirtualConfigReader"</span> <span class="na">type=</span><span class="s">"Magento\Payment\Gateway\ErrorMapper\VirtualConfigReader"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;arguments&gt;</span>
        <span class="nt">&lt;argument</span> <span class="na">name=</span><span class="s">"fileName"</span> <span class="na">xsi:type=</span><span class="s">"string"</span><span class="nt">&gt;</span>braintree_error_mapping.xml<span class="nt">&lt;/argument&gt;</span>
    <span class="nt">&lt;/arguments&gt;</span>
<span class="nt">&lt;/virtualType&gt;</span>
</code></pre></div></div>

<p>Also, specify a config instance for the data reader. You can also provide your own <code class="highlighter-rouge">cacheId</code>, which allows you to store all parsed messages in a cache.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;virtualType</span> <span class="na">name=</span><span class="s">"Magento\Braintree\Gateway\ErrorMapper\VirtualMappingData"</span> <span class="na">type=</span><span class="s">"Magento\Payment\Gateway\ErrorMapper\MappingData"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;arguments&gt;</span>
        <span class="nt">&lt;argument</span> <span class="na">name=</span><span class="s">"reader"</span> <span class="na">xsi:type=</span><span class="s">"object"</span><span class="nt">&gt;</span>Magento\Braintree\Gateway\ErrorMapper\VirtualConfigReader<span class="nt">&lt;/argument&gt;</span>
        <span class="nt">&lt;argument</span> <span class="na">name=</span><span class="s">"cacheId"</span> <span class="na">xsi:type=</span><span class="s">"string"</span><span class="nt">&gt;</span>braintree_error_mapper<span class="nt">&lt;/argument&gt;</span>
    <span class="nt">&lt;/arguments&gt;</span>
<span class="nt">&lt;/virtualType&gt;</span>
</code></pre></div></div>

<p>Then customize the default <code class="highlighter-rouge">ErrorMessageMapper</code> via virtual type and specify the data reader:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;virtualType</span> <span class="na">name=</span><span class="s">"Magento\Braintree\Gateway\ErrorMapper\VirtualErrorMessageMapper"</span> <span class="na">type=</span><span class="s">"Magento\Payment\Gateway\ErrorMapper\ErrorMessageMapper"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;arguments&gt;</span>
        <span class="nt">&lt;argument</span> <span class="na">name=</span><span class="s">"messageMapping"</span> <span class="na">xsi:type=</span><span class="s">"object"</span><span class="nt">&gt;</span>Magento\Braintree\Gateway\ErrorMapper\VirtualMappingData<span class="nt">&lt;/argument&gt;</span>
    <span class="nt">&lt;/arguments&gt;</span>
<span class="nt">&lt;/virtualType&gt;</span>
</code></pre></div></div>

<p>Because Braintree integration uses the default <a href="https://github.com/magento/magento2/blob/2.3-develop/app/code/Magento/Payment/Gateway/Command/GatewayCommand.php"><code class="highlighter-rouge">Magento\Payment\Gateway\Command\GatewayCommand</code></a>,
inject the created mapper pool to the required <a href="/guides/v2.3/payments-integrations/payment-gateway/gateway-command.html">gateway command</a> as an argument:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;virtualType</span> <span class="na">name=</span><span class="s">"BraintreeAuthorizeCommand"</span> <span class="na">type=</span><span class="s">"Magento\Payment\Gateway\Command\GatewayCommand"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;arguments&gt;</span>
        ...
        <span class="nt">&lt;argument</span> <span class="na">name=</span><span class="s">"errorMessageMapper"</span> <span class="na">xsi:type=</span><span class="s">"object"</span><span class="nt">&gt;</span>Magento\Braintree\Gateway\ErrorMapper\VirtualErrorMessageMapper<span class="nt">&lt;/argument&gt;</span>
    <span class="nt">&lt;/arguments&gt;</span>
<span class="nt">&lt;/virtualType&gt;</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">Magento\Payment\Gateway\Command\GatewayCommand</code> allows you to retrieve multiple error messages, but if your integration
does not use this feature, you can inject <code class="highlighter-rouge">ErrorMessageMapperInterface</code> to it as an argument. Then implement your own logic to the mapper error codes.</p>

<p>The payment integration should now retrieve error codes from the payment gateway response.</p>

<h2 id="retrieve-errors">Retrieve error codes from the response validator</h2>

<p>You can retrieve errors codes using a <a href="/guides/v2.3/payments-integrations/payment-gateway/response-validator.html">response validator</a>.
A response validator verifies response codes from the payment gateway.
It has different responsibilities and should not map messages, because it works on the lower layer of communication between Magento and the payment gateway.
It is the responsibility of a gateway command to call an appropriate service.</p>

<p>For example, Magento provides a response validator for Braintree: <a href="https://github.com/magento/magento2/blob/2.3-develop/app/code/Magento/Braintree/Gateway/Validator/GeneralResponseValidator.php"><code class="highlighter-rouge">\Magento\Braintree\Gateway\Validator\GeneralResponseValidator</code></a>.
Its implementation allows to retrieve errors codes from a response.</p>

<p>First, create a new code provider. It can be a simple class with a public method that should return a list of error codes by the provided response:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">class</span> <span class="nc">ErrorCodeProvider</span>
<span class="p">{</span>
    <span class="sd">/**
     * Retrieves list of error codes from Braintree response.
     *
     * @param Successful|Error $response
     * @return array
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getErrorCodes</span><span class="p">(</span><span class="nv">$response</span><span class="p">)</span><span class="o">:</span> <span class="k">array</span>
    <span class="p">{</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$response</span> <span class="nx">instanceof</span> <span class="nx">Error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="sd">/** @var ErrorCollection $collection */</span>
        <span class="nv">$collection</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">;</span>

        <span class="sd">/** @var Validation $error */</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$collection</span><span class="o">-&gt;</span><span class="na">deepAll</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$result</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$error</span><span class="o">-&gt;</span><span class="na">code</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Then add the created provider as a dependency to the <code class="highlighter-rouge">GeneralResponseValidator</code> class:</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">class</span> <span class="nc">GeneralResponseValidator</span> <span class="k">extends</span> <span class="nx">AbstractValidator</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span>
        <span class="nx">ResultInterfaceFactory</span> <span class="nv">$resultFactory</span><span class="p">,</span>
        <span class="nx">SubjectReader</span> <span class="nv">$subjectReader</span><span class="p">,</span>
        <span class="nx">ErrorCodeProvider</span> <span class="nv">$errorCodeProvider</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$resultFactory</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">subjectReader</span> <span class="o">=</span> <span class="nv">$subjectReader</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">errorCodeProvider</span> <span class="o">=</span> <span class="nv">$errorCodeProvider</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">validate</span><span class="p">(</span><span class="k">array</span> <span class="nv">$validationSubject</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="sd">/** @var Successful|Error $response */</span>
        <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">subjectReader</span><span class="o">-&gt;</span><span class="na">readResponseObject</span><span class="p">(</span><span class="nv">$validationSubject</span><span class="p">);</span>
    
        <span class="nv">$isValid</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nv">$errorMessages</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getResponseValidators</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$validator</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$validationResult</span> <span class="o">=</span> <span class="nv">$validator</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$validationResult</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                <span class="nv">$isValid</span> <span class="o">=</span> <span class="nv">$validationResult</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="nv">$errorMessages</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$errorMessages</span><span class="p">,</span> <span class="nv">$validationResult</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$errorCodes</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">errorCodeProvider</span><span class="o">-&gt;</span><span class="na">getErrorCodes</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
    
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createResult</span><span class="p">(</span><span class="nv">$isValid</span><span class="p">,</span> <span class="nv">$errorMessages</span><span class="p">,</span> <span class="nv">$errorCodes</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The <code class="highlighter-rouge">GeneralResponseValidator</code> returns an implementation of <a href="https://github.com/magento/magento2/blob/2.3-develop/app/code/Magento/Payment/Gateway/Validator/ResultInterface.php"><code class="highlighter-rouge">\Magento\Payment\Gateway\Validator\ResultInterface</code></a>
and the <code class="highlighter-rouge">\Magento\Payment\Gateway\Command\GatewayCommand</code> uses method <code class="highlighter-rouge">ResultInterface::getErrorCodes()</code> method to map error codes to user-friendly messages.</p>

			
		</div>
		<!-- /.content-wrap -->

		<div class="page-info">

    
  
    
    <div class="github-link">
      <a class="improve-page" href="https://github.com/magento/devdocs/blob/develop/guides/v2.3/payments-integrations/payment-gateway/error-code-mapper.md" target="_blank">
        去GitHub上编辑
      </a>
    </div>
    
  
    
    <div class="new-issue">
      <a href="https://github.com/magento/devdocs/issues/new?title=Feedback on page: /guides/v2.3/payments-integrations/payment-gateway/error-code-mapper.html" target="_blank">反馈</a>
    </div>
    
  
  </div>

	</section>
	<!-- /.content -->

</div> <!-- /.content-container -->


	</div>
	<!-- /.main-container -->
</div>
<!-- /#gl-wrapper -->

<!-- footer-->
<div class="page-footer">
  <div class="container">

    <div class="copyright-links">
      <ul class="nav footer-links">
  <li><a href="/guides/v2.3/contributor-guide/contributing_docs.html">成为贡献者</a>
  <li><a href="https://magento.github.io/glossary/index.html?audience=developer">术语表</a></li>
  <li><a href="http://magento.com/legal/terms/privacy/">隐私政策</a></li>
  <li><a href="http://magento.com/legal/terms/">服务条款</a></li>
  <li><a href="http://magento.com/legal/licensing/">许可/商标 常见问题</a></li>
  <li><a href="/guides/v2.3/release-notes/bk-release-notes.html">版本日志</a></li>
  <li><a href="/magento-third-party.html">三方许可</a></li>
</ul>

    </div>

		<div class="copyright-date">&copy; 2018 Magento. All rights reserved. translated by <a target="_blank" href="https://www.silksoftware.com">silksoftware co.ltd</a> - <a href="http://haiwera.xyz">Haiwera</a></div>

  </div>
</div>
<!-- / #footer -->


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="/assets/js/app.min.js"></script>


<script src="/common/js/devdocs.min.js"></script>




</body>
</html>

