<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width initial-scale=1" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<title>Varnish高级配置 | Magento 2 Developer Documentation</title>
	<meta name="description" content="Magento 2 Developer Documentation.
">

	<link rel="stylesheet" href="/assets/css/app.css" />
	<link rel="stylesheet" href="/assets/css/print.css" media="print"/>

	<link rel="stylesheet" href="/common/css/devdocs.css" />

	<script>
  var baseUrl = "";
  var algolia = {
    id : "E642SEDTHL",
    index:  "devdocs",
    key:  "d2d0f33ab73e291ef8d88d8b565e754c"
  };
</script>




	<link rel="canonical" href="/guides/v2.2/config-guide/varnish/config-varnish-advanced.html">

	<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="https://magento.com/favicon.ico">
	<link rel="apple-touch-icon" type="image/png" href="https://magento.com/apple-touch-icon.png">
	<link rel="apple-touch-icon" type="image/png" sizes="57x57" href="https://magento.com/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" type="image/png" sizes="72x72" href="https://magento.com/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://magento.com/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" type="image/png" sizes="114x114" href="https://magento.com/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://magento.com/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="https://magento.com/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://magento.com/apple-touch-icon-152x152.png">
	<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://magento.com/apple-touch-icon-180x180.png">

</head>
<body class="layout-default">

	<header class="site-header">

		<nav class="site-nav">

  <div class="menu-btn">
    <a id="menu-btn" class="menu-trigger menu-icon" href="#nav-main" aria-haspopup="true" aria-controls="nav-main"></a>
  </div>

  <div class="nav-container">

    <a class="logo" href="/">
      <img src="/assets/i/m-logo.svg" alt=""><img src="/assets/i/magento-logo.svg" alt="Magento" class="magento-logo" />
      <span class="site-logo">DevDocs</span>
    </a>

    <div id="nav-main" class="nav-main-wrap" aria-labelledby="menu-btn">
      
<div class="version-switcher dropdown" data-version="2.2">
	<button id="version-switcher-button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Magento 2.2
	</button>

	<ul class="dropdown-menu dropdown-menu-left" aria-labelledby="version-switcher-button">
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.0/config-guide/varnish/config-varnish-advanced.html">Magento 2.0</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.1/config-guide/varnish/config-varnish-advanced.html">Magento 2.1</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.2/config-guide/varnish/config-varnish-advanced.html">Magento 2.2</a></li>
	
		<li><a class="dropdown-item" data-proofer-ignore href="/guides/v2.3/config-guide/varnish/config-varnish-advanced.html">Magento 2.3 Pre-release</a></li>
	
  </ul>

</div>


      <!-- Main Navigation -->
<ul class="nav-main" role="menubar">

  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">部署</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
          <li><a href="/guides/v2.2/install-gde/bk-install-guide.html">安装向导</a></li>
          
          <li><a href="/guides/v2.2/comp-mgr/bk-compman-upgrade-guide.html">扩展安装及系统升级手册</a></li>
          
          <li><a href="/guides/v2.2/config-guide/bk-config-guide.html">配置手册</a></li>
          
          <li><a href="/guides/v2.2/performance-best-practices/index.html">高效实践</a></li>
          
          <li><a href="/guides/v2.2/migration/bk-migration-guide.html">迁移指引</a></li>
          <li><a href="/guides/v2.2/cloud/bk-cloud.html">上云指引</a></li>
          <li><a href="/magento-release-information.html">版本日志</a></li>
      </ul>
    </div>

  </li>


  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">开发</span>

    <div class="nav-popup" role="menu" aria-hidden="true">

      <div class="nav-section">
        <div class="nav-section-title">服务端</div>
        <ul>
          <li><a href="/guides/v2.2/architecture/bk-architecture.html">架构说明</a></li>
          <li><a href="/guides/v2.2/extension-dev-guide/bk-extension-dev-guide.html">PHP开发文档</a></li>
          <li><a href="/guides/v2.2/ext-best-practices/bk-ext-best-practices.html">扩展开发实践</a></li>
          <li><a href="/guides/v2.2/mrg/intro.html">各模块介绍</a></li>
          <li><a href="/guides/v2.2/coding-standards/bk-coding-standards.html">编码规范</a></li>
          <li><a href="/guides/v2.2/contributor-guide/contributing.html">贡献指引</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">前端</div>
        <ul>
          <li class=""><a href="/guides/v2.2/frontend-dev-guide/bk-frontend-dev-guide.html">前端工程师手册</a></li>
          
          <li><a href="/guides/v2.2/ui_comp_guide/bk-ui_comps.html">UI组件手册</a></li>
          
          <li><a href="/guides/v2.2/javascript-dev-guide/bk-javascript-dev-guide.html">JavaScript开发手册</a></li>
          <li><a href="/guides/v2.2/pattern-library/bk-pattern.html">管理面板设计模式及所用库</a></li>
          <li><a href="/guides/v2.2/design-styleguide/bk-styleguide.html">管理面板样式手册</a></li>
          <li><a href="https://magento-research.github.io/pwa-devdocs/">PWA Studios</a></li>
        </ul>
      </div>

      <div class="nav-section">
        <div class="nav-section-title"><abbr>API</abbr></div>
        <ul>
          <li><a href="/guides/v2.2/get-started/bk-get-started-api.html">Web APIs起步</a></li>
          <li><a href="/guides/v2.2/rest/bk-rest.html">REST API参考</a></li>
          <li><a href="/guides/v2.2/soap/bk-soap.html">SOAP API参考</a></li>
          
          
          <li><a href="/guides/v2.2/marketplace/eqp/api.html">Marketplace EQP API Reference</a></li>
          
        </ul>
      </div>
    </div>

  </li>


  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">测试</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
        <li><a href="/guides/v2.2/test/testing.html">Magento测试手册</a></li>
        
        <li><a href="/guides/v2.2/magento-functional-testing-framework/release-2/introduction.html">功能验收测试(新!)</a></li>
        
        <li><a href="/guides/v2.2/mtf/mtf_introduction.html">功能测试</a></li>
        <li><a href="/guides/v2.2/test/integration/integration_test_execution.html">集成测试</a></li>
        <li><a href="/guides/v2.2/test/js/jasmine.html">JavaScript单元测试</a></li>
        <li><a href="/guides/v2.2/test/unit/unit_test_execution.html">PHP单元测试</a></li>
        <li><a href="/guides/v2.2/get-started/web-api-functional-testing.html">Web API功能测试</a></li>
      </ul>
    </div>

  </li>


  <li class="nav-main-separator"></li>


  <li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">功能文档</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
          
          <li class="leaf"><a href="/guides/v2.2/advanced-reporting/overview.html">高级报表</a></li>
          
        
        <li class="leaf"><a href="/guides/v2.2/b2b/bk-b2b.html">B2B</a></li>
        
        <li><a href="/guides/v2.2/howdoi/checkout/checkout_overview.html">Checkout</a></li>
        <li><a href="/guides/v2.2/payments-integrations/bk-payments-integrations.html">支付集成</a></li>
        
          <li><a href="/guides/v2.2/extension-dev-guide/staging.html">Staging</a></li>
        
      </ul>
    </div>

  </li>


  <li class="nav-main-item"  tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">指引</span>

    <div class="nav-popup" role="menu" aria-hidden="true">
      <ul>
        <li><a href="/guides/v2.2/howdoi/bk-how-do-i.html">如何</a></li>
        
        <li><a  data-proofer-ignore href="/guides/v2.2/get-started/order-tutorial/order-intro.html">使用EST APIs处理订单</a></li>
        

        <li><a href="/videos/">视频教程</a></li>
      </ul>
    </div>

  </li>

</ul><!-- /.nav-main -->

    </div>

    <div class="search-btn">
      <a class="search-trigger search-icon" href="#"></a>
    </div>

    <form class="quick-search" action="/guides/v2.2/search.html" method="get" novalidate="novalidate">
      <input type="search" name="q" placeholder="Search" />
      <a href="#" class="quick-search-close">&times;</a>
    </form>

  </div>

</nav><!-- #site-nav -->
<div class="nav-main-fader"></div>


	</header>

	<div class="global-wrapper">

		<div class="main-container">
			<a id="main-content"></a>


<div class="content-container">

	<!-- sidebar -->
<aside class="sidebar">
	<a href="#" data-proofer-ignore class="toc-toggler">内容表格</a>
	<div class="sidebar-wrapper">

		

		<h4 class="guide-title">配置手册</h4>
		<div class="collapsible-navigation">
		    <ul>
		    
		    	

<li class="nav-level1  " id="介绍">
    

    
    <a href="/guides/v2.2/config-guide/bk-config-guide.html">介绍</a>
    

    
</li>


		    
		    	

<li class="nav-level1  " id="安全设置">
    

    
    <a href="/guides/v2.2/config-guide/secy/secy.html">安全设置</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="确保cron.php文件在浏览器上的安全">

            

            
            <a href="/guides/v2.2/config-guide/secy/secy-cron.html">确保cron.php文件在浏览器上的安全</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="x-frame-options头">

            

            
            <a href="/guides/v2.2/config-guide/secy/secy-xframe.html">X-Frame-Options头</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="防止缓存中毒">

            

            
            <a href="/guides/v2.2/config-guide/secy/secy-headers.html">防止缓存中毒</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="magento初始化和引导">
    

    
    <a href="/guides/v2.2/config-guide/bootstrap/magento-bootstrap.html">Magento初始化和引导</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="设置引导参数">

            

            
            <a href="/guides/v2.2/config-guide/bootstrap/magento-how-to-set.html">设置引导参数</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="关于magento的模式">

            

            
            <a href="/guides/v2.2/config-guide/bootstrap/magento-modes.html">关于Magento的模式</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="自定义基础目录路径(mage_dirs)">

            

            
            <a href="/guides/v2.2/config-guide/bootstrap/mage-dirs.html">自定义基础目录路径(MAGE_DIRS)</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="开启扼要记录(mage_profiler)">

            

            
            <a href="/guides/v2.2/config-guide/bootstrap/mage-profiler.html">开启扼要记录(MAGE_PROFILER)</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="管道部署">
    

    
    <a href="/guides/v2.2/config-guide/deployment/">管道部署</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="overview">

            

            
            <a href="/guides/v2.2/config-guide/deployment/pipeline/">Overview</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="技术细节">

            

            
            <a href="/guides/v2.2/config-guide/deployment/pipeline/technical-details.html">技术细节</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="开发系统设置">

            

            
            <a href="/guides/v2.2/config-guide/deployment/pipeline/development-system.html">开发系统设置</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="构建系统设置">

            

            
            <a href="/guides/v2.2/config-guide/deployment/pipeline/build-system.html">构建系统设置</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="生产系统设置">

            

            
            <a href="/guides/v2.2/config-guide/deployment/pipeline/production-system.html">生产系统设置</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="文件系统访问权限">

            

            
            <a href="/guides/v2.2/config-guide/prod/prod_file-sys-perms.html">文件系统访问权限</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="examples">

            

            
            <span>Examples</span>
            

            
            <ul>
                

                
                
                <li class="nav-level3  " id="共享配置">
                    

                    
                    <a  href="/guides/v2.2/config-guide/deployment/pipeline/example/shared-configuration.html">共享配置</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="使用命令行命令">
                    

                    
                    <a  href="/guides/v2.2/config-guide/deployment/pipeline/example/cli.html">使用命令行命令</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="使用环境变量">
                    

                    
                    <a  href="/guides/v2.2/config-guide/deployment/pipeline/example/environment-variables.html">使用环境变量</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="使用rsync同步命令">
                    

                    
                    <a  href="/guides/v2.2/config-guide/deployment/pipeline/example/rsync.html">使用rsync同步命令</a>
                    

                    
                </li>
                
                
            </ul>
            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="单机部署">
    

    
    <a href="/guides/v2.2/config-guide/deployment/single-machine.html">单机部署</a>
    

    
</li>


		    
		    	

<li class="nav-level1  " id="命令行配置">
    

    
    <a href="/guides/v2.2/config-guide/cli/config-cli.html">命令行配置</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="命令行配置起步">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands.html">命令行配置起步</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="管理缓存">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-cache.html">管理缓存</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="管理索引">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-index.html">管理索引</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="配置和执行定时任务">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-cron.html">配置和执行定时任务</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="代码编译器">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-compiler.html">代码编译器</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="设置magento的模式">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-mode.html">设置Magento的模式</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="统一资源名称(urn)高亮">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-urn.html">统一资源名称(URN)高亮</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="依赖报告">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-depen.html">依赖报告</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="配置管理">

            

            
            <span>配置管理</span>
            

            
            <ul>
                

                
                
                <li class="nav-level3  " id="导出配置">
                    

                    
                    <a  href="/guides/v2.2/config-guide/cli/config-cli-subcommands-config-mgmt-export.html">导出配置</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="设置配置值">
                    

                    
                    <a  href="/guides/v2.2/config-guide/cli/config-cli-subcommands-config-mgmt-set.html">设置配置值</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="从配置文件导入数据">
                    

                    
                    <a  href="/guides/v2.2/config-guide/cli/config-cli-subcommands-config-mgmt-import.html">从配置文件导入数据</a>
                    

                    
                </li>
                
                
            </ul>
            
        </li>
        
        
        
        
        <li class="nav-level2  " id="翻译字典和语言包">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-i18n.html">翻译字典和语言包</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="静态视图文件部署">

            

            
            <span>静态视图文件部署</span>
            

            
            <ul>
                

                
                
                <li class="nav-level3  " id="静态文件部署策略">
                    

                    
                    <a  href="/guides/v2.2/config-guide/cli/config-cli-subcommands-static-deploy-strategies.html">静态文件部署策略</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="部署静态视图文件">
                    

                    
                    <a  href="/guides/v2.2/config-guide/cli/config-cli-subcommands-static-view.html">部署静态视图文件</a>
                    

                    
                </li>
                
                
            </ul>
            
        </li>
        
        
        
        
        <li class="nav-level2  " id="创建软链接到less文件">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-less-sass.html">创建软链接到LESS文件</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="运行单元测试">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-test.html">运行单元测试</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="转换布局的xml文件">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-layout-xml.html">转换布局的XML文件</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="为性能测试生成数据">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-perf-data.html">为性能测试生成数据</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="运行magento支持工具-(仅企业版适用)">

            

            
            <a href="/guides/v2.2/config-guide/cli/config-cli-subcommands-spt-util.html">运行Magento支持工具 (仅企业版适用)</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="magento配置文件">
    

    
    <a href="/guides/v2.2/config-guide/config/config-magento.html">Magento配置文件</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="magento的部署配置">

            

            
            <a href="/guides/v2.2/config-guide/config/config-php.html">Magento的部署配置</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="模块配置文件">

            

            
            <a href="/guides/v2.2/config-guide/config/config-files.html">模块配置文件</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="创建或扩展配置类型">

            

            
            <a href="/guides/v2.2/config-guide/config/config-create.html">创建或扩展配置类型</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="禁用模块输出">

            

            
            <a href="/guides/v2.2/config-guide/config/disable-module-output.html">禁用模块输出</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="配置参考">

            

            
            <span>配置参考</span>
            

            
            <ul>
                

                
                
                <li class="nav-level3  " id="敏感的和系统特定的">
                    

                    
                    <a  href="/guides/v2.2/config-guide/prod/config-reference-sens.html">敏感的和系统特定的</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="支付配置路径参考">
                    

                    
                    <a  href="/guides/v2.2/config-guide/prod/config-reference-payment.html">支付配置路径参考</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="其它配置路径参考">
                    

                    
                    <a  href="/guides/v2.2/config-guide/prod/config-reference-most.html">其它配置路径参考</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="magento-commerce-for-b2b-extension-configuration-paths-reference">
                    

                    
                    <a  href="/guides/v2.2/config-guide/prod/config-reference-b2b.html">Magento Commerce for B2B Extension configuration paths reference</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id=".gitignore参考">
                    

                    
                    <a  href="/guides/v2.2/config-guide/prod/config-reference-gitignore.html">.gitignore参考</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="使用环境变量覆盖配置设置">
                    

                    
                    <a  href="/guides/v2.2/config-guide/prod/config-reference-var-name.html">使用环境变量覆盖配置设置</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="config.php参考">
                    

                    
                    <a  href="/guides/v2.2/config-guide/prod/config-reference-configphp.html">config.php参考</a>
                    

                    
                </li>
                
                

                
                
                <li class="nav-level3  " id="env.php参考">
                    

                    
                    <a  href="/guides/v2.2/config-guide/prod/config-reference-envphp.html">env.php参考</a>
                    

                    
                </li>
                
                
            </ul>
            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="配置缓存">
    

    
    <a href="/guides/v2.2/config-guide/cache.html">配置缓存</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="将缓存前端与缓存类型关联">

            

            
            <a href="/guides/v2.2/config-guide/cache/cache-types.html">将缓存前端与缓存类型关联</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="底层缓存选项">

            

            
            <a href="/guides/v2.2/config-guide/cache/cache-options.html">底层缓存选项</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="静态内容签名">

            

            
            <a href="/guides/v2.2/config-guide/cache/static-content-signing.html">静态内容签名</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="配置redis">
    

    
    <a href="/guides/v2.2/config-guide/redis/config-redis.html">配置Redis</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="使用redis作为magento页面缓存和默认缓存">

            

            
            <a href="/guides/v2.2/config-guide/redis/redis-pg-cache.html">使用Redis作为Magento页面缓存和默认缓存</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="使用redis作为session存储">

            

            
            <a href="/guides/v2.2/config-guide/redis/redis-session.html">使用Redis作为Session存储</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="配置和使用varnish">
    

    
    <a href="/guides/v2.2/config-guide/varnish/config-varnish.html">配置和使用Varnish</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="安装varnish">

            

            
            <a href="/guides/v2.2/config-guide/varnish/config-varnish-install.html">安装Varnish</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="配置varnish和你的web服务器">

            

            
            <a href="/guides/v2.2/config-guide/varnish/config-varnish-configure.html">配置Varnish和你的web服务器</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="配置magento使用varnish">

            

            
            <a href="/guides/v2.2/config-guide/varnish/config-varnish-magento.html">配置Magento使用Varnish</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2 active " id="varnish高级配置">

            

            
            <a href="/guides/v2.2/config-guide/varnish/config-varnish-advanced.html">Varnish高级配置</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="how-magento-cache-clearing-works-with-multiple-varnish-instances">

            

            
            <a href="/guides/v2.2/config-guide/varnish/use-multiple-varnish-cache.html">How Magento cache clearing works with multiple Varnish instances</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="最终校验">

            

            
            <a href="/guides/v2.2/config-guide/varnish/config-varnish-final.html">最终校验</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="在varnish下magento的缓存清除是如何工作的">

            

            
            <a href="/guides/v2.2/config-guide/varnish/use-varnish-cache.html">在Varnish下Magento的缓存清除是如何工作的</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="varnish缓存是如何工作的">

            

            
            <a href="/guides/v2.2/config-guide/varnish/use-varnish-cache-how.html">Varnish缓存是如何工作的</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="排除503错误">

            

            
            <a href="/guides/v2.2/config-guide/varnish/tshoot-varnish-503.html">排除503错误</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="使用memcached做为session存储">
    

    
    <a href="/guides/v2.2/config-guide/memcache/memcache.html">使用memcached做为session存储</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="在ubuntu上安装、配置和验证memcached">

            

            
            <a href="/guides/v2.2/config-guide/memcache/memcache_ubuntu.html">在Ubuntu上安装、配置和验证memcached</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="在centos上安装、配置和验证memcached">

            

            
            <a href="/guides/v2.2/config-guide/memcache/memcache_centos.html">在CentOS上安装、配置和验证memcached</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="配置magento使用memcached">

            

            
            <a href="/guides/v2.2/config-guide/memcache/memcache_magento.html">配置Magento使用memcached</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="多站和多店">
    

    
    <a href="/guides/v2.2/config-guide/multi-site/ms_over.html">多站和多店</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="在管理面板设置多站、多店及网店视图">

            

            
            <a href="/guides/v2.2/config-guide/multi-site/ms_websites.html">在管理面板设置多站、多店及网店视图</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="教程-在nginx下设置多站或多店">

            

            
            <a href="/guides/v2.2/config-guide/multi-site/ms_nginx.html">教程-在nginx下设置多站或多店</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="教程-在apache下设置多站或多店">

            

            
            <a href="/guides/v2.2/config-guide/multi-site/ms_apache.html">教程-在Apache下设置多站或多店</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="设置自定义的定时任务和任务组(cron)">
    

    
    <a href="/guides/v2.2/config-guide/cron/custom-cron.html">设置自定义的定时任务和任务组(cron)</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="自定义的定时任务和任务组(cron)参考">

            

            
            <a href="/guides/v2.2/config-guide/cron/custom-cron-ref.html">自定义的定时任务和任务组(cron)参考</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="配置自定义的定时任务和任务组(cron)(教程)">

            

            
            <a href="/guides/v2.2/config-guide/cron/custom-cron-tut.html">配置自定义的定时任务和任务组(cron)(教程)</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="配置数据库分析器">
    

    
    <a href="/guides/v2.2/config-guide/db-profiler/db-profiler.html">配置数据库分析器</a>
    

    
</li>


		    
		    	

<li class="nav-level1  " id="安装和配置elasticsearch-(仅企业版适用)">
    

    
    <a href="/guides/v2.2/config-guide/elasticsearch/es-overview.html">安装和配置Elasticsearch (仅企业版适用)</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="配置nginx和elasticsearch">

            

            
            <a href="/guides/v2.2/config-guide/elasticsearch/es-config-nginx.html">配置nginx和Elasticsearch</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="配置apache和elasticsearch">

            

            
            <a href="/guides/v2.2/config-guide/elasticsearch/es-config-apache.html">配置Apache和Elasticsearch</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="配置elasticsearch停用词">

            

            
            <a href="/guides/v2.2/config-guide/elasticsearch/es-config-stopwords.html">配置Elasticsearch停用词</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="配置magento使用elasticsearch">

            

            
            <a href="/guides/v2.2/config-guide/elasticsearch/configure-magento.html">配置Magento使用Elasticsearch</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="消息队列-(仅企业版适用)">
    

    
    <a href="/guides/v2.2/config-guide/mq/rabbitmq-overview.html">消息队列 (仅企业版适用)</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="管理消息队列">

            

            
            <a href="/guides/v2.2/config-guide/mq/manage-mysql.html">管理消息队列</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

		    
		    	

<li class="nav-level1  " id="数据库分库执行方案(仅企业版)">
    

    
    <a href="/guides/v2.2/config-guide/multi-master/multi-master.html">数据库分库执行方案(仅企业版)</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="自动配置主数据库">

            

            
            <a href="/guides/v2.2/config-guide/multi-master/multi-master_masterdb.html">自动配置主数据库</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="手动配置主数据库">

            

            
            <a href="/guides/v2.2/config-guide/multi-master/multi-master_manual.html">手动配置主数据库</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="数据库分库验证">

            

            
            <a href="/guides/v2.2/config-guide/multi-master/multi-master_verify.html">数据库分库验证</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="设置可选数据库复制">

            

            
            <a href="/guides/v2.2/config-guide/multi-master/multi-master_slavedb.html">设置可选数据库复制</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="自定义日志">
    

    
    <a href="/guides/v2.2/config-guide/log/log-intro.html">自定义日志</a>
    

    
    <ul>
        
        
        
        <li class="nav-level2  " id="magento日志的更多细节">

            

            
            <a href="/guides/v2.2/config-guide/log/log-magento.html">Magento日志的更多细节</a>
            

            
        </li>
        
        
        
        
        <li class="nav-level2  " id="示例---记录数据库活动日志">

            

            
            <a href="/guides/v2.2/config-guide/log/log-db.html">示例 - 记录数据库活动日志</a>
            

            
        </li>
        
        
    </ul>
    
</li>


		    
		    	

<li class="nav-level1  " id="如何定位你的session文件">
    

    
    <a href="/guides/v2.2/config-guide/sessions.html">如何定位你的session文件</a>
    

    
</li>


		    
		    	

		    
		    	

		    
		    </ul>
		</div>

	</div>

</aside>
<!-- /sidebar -->


	<section class="content">
		<div class="content-wrap">
			<!-- page-header -->
<section class="page-intro">
	

  <nav class="breadcrumbs">

    <ol class="breadcrumb list-unstyled" vocab="http://schema.org/" typeof="BreadcrumbList">

      <li class="breadcrumb-item"><a class="breadcrumb-item" href="/"><span>首页</span></a></li>

    <!-- Iteration breadcrumb item -->
    
    

    

      <!-- Skip if root -->
      

      <!-- Get breadcrumb title -->
      

      <!-- SEO data -->
      

      <li class="breadcrumb-item" property="itemListElement" typeof="ListItem">

        
          <a property="item" typeof="WebPage" href="/guides/v2.2/config-guide/bk-config-guide.html">
            <span property="name">配置手册</span>
          </a>
        

        <meta property="position" content="1" />
      </li>

    

      <!-- Skip if root -->
      

      <!-- Get breadcrumb title -->
      

      <!-- SEO data -->
      

      <li class="breadcrumb-item active" property="itemListElement" typeof="ListItem">

        

          

          <span property="name">Varnish高级配置</span>

        

        <meta property="position" content="2" />
      </li>

    

    </ol>

  </nav>



	

	

	<h1 class="page-heading">Varnish高级配置</h1>

  


</section>

			<p>Varnish provides several features that prevent customers from experiencing long delays and timeouts when the Magento server is not functioning properly. These features can be configured in the <code class="highlighter-rouge">default.vcl</code> file. This topic describes the additions that Magento provides in the VCL (Varnish Configuration Language) file you download from <span term-uuid="18b930cf-09cc-47c9-a5e5-905f86c43f81" class="glossary-term" data-toggle="popover">Magento管理面板</span>.</p>

<p>See the <a href="https://www.varnish-cache.org/docs/4.1/reference/index.html">Varnish Reference Manual</a> for details about using the Varnish Configuration Language.</p>

<h2 id="health">Health check</h2>
<p>Varnish’s health check feature polls the Magento server to determine whether it is responding in a timely manner. If it is responding normally, fresh content will be regenerated after the Time to Live (TTL) period has expired. If not, Varnish always serves stale content.</p>

<p>Magento defines the following default health check:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="err">.probe</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">.url</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="s2">"/pub/health_check.php"</span><span class="err">;</span><span class="w">
    </span><span class="err">.timeout</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">2</span><span class="err">s;</span><span class="w">
    </span><span class="err">.interval</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">5</span><span class="err">s;</span><span class="w">
    </span><span class="err">.window</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">10</span><span class="err">;</span><span class="w">
    </span><span class="err">.threshold</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">5</span><span class="err">;</span><span class="w">
    </span><span class="p">}</span></code></pre></figure>

<p>Every 5 seconds, this health check calls the <code class="highlighter-rouge">pub/health_check.php</code> script. This script checks the availability of the server, each database, and Redis (if installed). The script must return a response within 2 seconds. If the script determines that any of these resources are down, it returns a 500 HTTP error code. If this error code is received in 6 out of 10 attempts, the <span term-uuid="74d6d228-34bd-4475-a6f8-0c0f4d6d0d61" class="glossary-term" data-toggle="popover">后端</span> is considered unhealthy.</p>

<p>The <code class="highlighter-rouge">health_check.php</code> script is located in the <code class="highlighter-rouge">pub</code> directory. If your Magento root directory is <code class="highlighter-rouge">pub</code>, then be sure to change the path in the <code class="highlighter-rouge">url</code> parameter from <code class="highlighter-rouge">/pub/health_check.php</code> to <code class="highlighter-rouge">health_check.php</code>.</p>

<p>For more information, see the <a href="https://varnish-cache.org/docs/4.1/users-guide/vcl-backends.html?highlight=health%20check#health-checks" target="_blank">Varnish health checks</a> documentation.</p>

<h2 id="grace">Grace mode</h2>

<p>Grace mode enables Varnish to keep an object in <span term-uuid="0bc9c8bc-de1a-4a06-9c99-a89a29c30645" class="glossary-term" data-toggle="popover">缓存</span> beyond its TTL value. Varnish can then serve the expired (stale) content while it fetches a new version. This improves the flow of traffic and decreases load times. It’s used in the following situations:</p>

<ul>
  <li>When the Magento backend is healthy, but a request is taking longer than normal</li>
  <li>When the Magento backend is not healthy.</li>
</ul>

<p>The <code class="highlighter-rouge">vcl_hit</code> subroutine defines how Varnish responds to a request for objects that have been cached.</p>

<h3 id="grace-healthy">When the Magento backend is healthy</h3>

<p>When the health checks determine that the Magento backend is healthy, Varnish checks whether time remains in the grace period. The default grace period is 300 seconds, but a merchant can set the value from <span term-uuid="29ddb393-ca22-4df9-a8d4-0024d75739b1" class="glossary-term" data-toggle="popover">Admin</span> as described in <a href="/guides/v2.2/config-guide/varnish/config-varnish-magento.html">配置Magento使用Varnish</a>. If the grace period hasn’t expired, Varnish delivers the stale content, and asynchronously refreshes the object from the Magento server. If the grace period has expired, Varnish serves the stale content and synchronously refreshes the object from the Magento backend.</p>

<p>The maximum amount of time that Varnish serves a stale object is the sum of the grace period (300 seconds by default) and the TTL value (86400 seconds by default).</p>

<p>To change the default grace period from within the <code class="highlighter-rouge">default.vcl</code> file, edit the following line in the <code class="highlighter-rouge">vcl_hit</code> subroutine:</p>

<p><code class="highlighter-rouge">if (obj.ttl + 300s &gt; 0s) {</code></p>

<h3 id="grace-unhealthy">When the Magento backend is not healthy</h3>

<p>If the Magento backend is not responsive, Varnish serves stale content from cache for three days (or as defined in <code class="highlighter-rouge">beresp.grace</code>) plus the remaining TTL (which by default is one day), unless the cached content is manually purged.</p>

<h2 id="saint">Saint mode</h2>

<p>Saint mode blacklists unhealthy backends for a configurable amount of time. As a result, unhealthy backends cannot serve traffic when using Varnish as a load balancer. Saint mode can be used in conjunction with grace mode to allow for complex handling of unhealthy backend servers. 例如， if one backend server is unhealthy, retries can be routed to another server. If all other servers are down, then serve stale cached objects. The saint mode backend hosts and blackout periods are defined in the <code class="highlighter-rouge">default.vcl</code> file.</p>

<p>Saint mode can also be used when Magento instances are individually taken offline to perform maintenance and upgrade tasks without affecting the availability of the Magento site.</p>

<h3 id="saint-prereq">Saint mode prerequisites</h3>
<p>You should designate one machine as the primary installation. On this machine, install the main instance of Magento, mySQL database, and Varnish.</p>

<p>On all other machines, the Magento instance must have access the primary machine’s mySQL database. The secondary machines should also have access to the files of the primary Magento instance.</p>

<p>Alternatively, <span term-uuid="363662cb-73f1-4347-a15e-2d2adabeb0c2" class="glossary-term" data-toggle="popover">static files</span> versioning can be turned off on all machines. This can be accessed from the Admin under <strong>Stores &gt; Configuration &gt; Advanced &gt; Developer &gt; Static Files Settings &gt; Sign Static Files</strong> = <strong>No</strong>.</p>

<p>Finally, all Magento instances must be in production mode. Before Varnish starts, clear the cache on each instance. In Admin, go to <strong>System &gt; Cache Management</strong> and click <strong>Flush Magento Cache</strong>. You can also run the following command to clear the cache:</p>

<p><code class="highlighter-rouge">bin/magento cache:flush</code></p>

<h3 id="saint-install">安装</h3>

<p>Saint mode is not part of the main Varnish package. It is a separately-versioned vmod that must be downloaded and installed. As a result, you should re-compile Varnish from source, as described in the following articles:</p>

<ul>
  <li><a href="https://www.varnish-cache.org/docs/5.0/installation/install.html">Installing Varnish 5.0</a></li>
  <li><a href="https://www.varnish-cache.org/docs/4.1/installation/install.html">Installing Varnish 4.1</a></li>
  <li><a href="https://www.varnish-cache.org/docs/4.0/installation/install.html">Installing Varnish 4.0</a></li>
</ul>

<p>After you’ve recompiled, you can install the Saint mode <span term-uuid="c1e4242b-1f1a-44c3-9d72-1d5b1435e142" class="glossary-term" data-toggle="popover">模块</span>. In general, follow these steps:</p>

<ol>
<li><p>Obtain the source code from <a href="https://github.com/varnish/varnish-modules">Varnish modules</a> . Clone the git version (master version) since the 0.9.x versions contain a source code error.</p></li>

<li><p>Build the source code with autotools:</p>

<p><code>sudo apt-get install libvarnishapi-dev || sudo yum install varnish-libs-devel</code></p>
<p><code>./bootstrap   # If running from git.</code></p>
<p><code>./configure</code></p>
<p><code>make</code></p>
<p><code>make check   # optional</code></p>
<p><code>sudo make install</code></p>
</li></ol>

<p>See <a href="https://github.com/varnish/varnish-modules">Varnish module collection</a> for information about installing the Saint mode module.</p>

<h3 id="saint-sample">Sample <code class="highlighter-rouge">vcl</code> file</h3>

<p>The following code example shows the code that must be added to your VCL file to enable saint mode. Place the <code class="highlighter-rouge">import</code> statements and <code class="highlighter-rouge">backend</code> definitions at the top of the file.</p>

<div class="collapsible"><b class="collapsible-title">Click to show/hide </b><div class="collapsible-content"><figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">import</span> <span class="n">saintmode</span><span class="p">;</span>
<span class="n">import</span> <span class="n">directors</span><span class="p">;</span>

<span class="n">backend</span> <span class="n">default1</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">host</span> <span class="o">=</span> <span class="s">"192.168.0.1"</span><span class="p">;</span>
    <span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="s">"8080"</span><span class="p">;</span>
    <span class="p">.</span><span class="n">first_byte_timeout</span> <span class="o">=</span> <span class="mi">600</span><span class="n">s</span><span class="p">;</span>
        <span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="s">"/pub/health_check.php"</span><span class="p">;</span>
            <span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="n">s</span><span class="p">;</span>
            <span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">5</span><span class="n">s</span><span class="p">;</span>
            <span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
            <span class="p">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="n">backend</span> <span class="n">default2</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">host</span> <span class="o">=</span> <span class="s">"192.168.0.2"</span><span class="p">;</span>
    <span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="s">"8080"</span><span class="p">;</span>
    <span class="p">.</span><span class="n">first_byte_timeout</span> <span class="o">=</span> <span class="mi">600</span><span class="n">s</span><span class="p">;</span>
    <span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="s">"/pub/health_check.php"</span><span class="p">;</span>
        <span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="n">s</span><span class="p">;</span>
        <span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">5</span><span class="n">s</span><span class="p">;</span>
        <span class="p">.</span><span class="n">window</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
        <span class="p">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">sub</span> <span class="n">vcl_init</span> <span class="p">{</span>
    <span class="cp"># Instantiate sm1, sm2 for backends tile1, tile2
</span>    <span class="cp"># with 10 blacklisted objects as the threshold for marking the
</span>    <span class="cp"># whole backend sick.
</span>    <span class="k">new</span> <span class="n">sm1</span> <span class="o">=</span> <span class="n">saintmode</span><span class="p">.</span><span class="n">saintmode</span><span class="p">(</span><span class="n">default1</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="k">new</span> <span class="n">sm2</span> <span class="o">=</span> <span class="n">saintmode</span><span class="p">.</span><span class="n">saintmode</span><span class="p">(</span><span class="n">default2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

    <span class="cp"># Add both to a director. Use sm0, sm1 in place of tile1, tile2.
</span>    <span class="cp"># Other director types can be used in place of random.
</span>    <span class="k">new</span> <span class="n">magedirector</span> <span class="o">=</span> <span class="n">directors</span><span class="p">.</span><span class="n">random</span><span class="p">();</span>
    <span class="n">magedirector</span><span class="p">.</span><span class="n">add_backend</span><span class="p">(</span><span class="n">sm1</span><span class="p">.</span><span class="n">backend</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">magedirector</span><span class="p">.</span><span class="n">add_backend</span><span class="p">(</span><span class="n">sm2</span><span class="p">.</span><span class="n">backend</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">sub</span> <span class="n">vcl_backend_fetch</span> <span class="p">{</span>
    <span class="cp"># Get a backend from the director.
</span>    <span class="cp"># When returning a backend, the director will only return backends
</span>    <span class="cp"># saintmode says are healthy.
</span>    <span class="n">set</span> <span class="n">bereq</span><span class="p">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">magedirector</span><span class="p">.</span><span class="n">backend</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">sub</span> <span class="n">vcl_backend_response</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">beresp</span><span class="p">.</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">)</span> <span class="p">{</span>
        <span class="cp"># This marks the backend as sick for this specific
</span>        <span class="cp"># object for the next 20s.
</span>        <span class="n">saintmode</span><span class="p">.</span><span class="n">blacklist</span><span class="p">(</span><span class="mi">20</span><span class="n">s</span><span class="p">);</span>
        <span class="cp"># Retry the request. This will result in a different backend
</span>        <span class="cp"># being used.
</span>        <span class="k">return</span> <span class="p">(</span><span class="n">retry</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>
</div></div>

<h4 id="final-step">Final step</h4>
<p><a href="/guides/v2.2/config-guide/varnish/config-varnish-final.html">最终校验</a></p>

			
		</div>
		<!-- /.content-wrap -->

		<div class="page-info">

    
  
    
    <div class="github-link">
      <a class="improve-page" href="https://github.com/magento/devdocs/blob/develop/guides/v2.2/config-guide/varnish/config-varnish-advanced.md" target="_blank">
        去GitHub上编辑
      </a>
    </div>
    
  
    
    <div class="new-issue">
      <a href="https://github.com/magento/devdocs/issues/new?title=Feedback on page: /guides/v2.2/config-guide/varnish/config-varnish-advanced.html" target="_blank">反馈</a>
    </div>
    
  
  </div>

	</section>
	<!-- /.content -->

</div> <!-- /.content-container -->


	</div>
	<!-- /.main-container -->
</div>
<!-- /#gl-wrapper -->

<!-- footer-->
<div class="page-footer">
  <div class="container">

    <div class="copyright-links">
      <ul class="nav footer-links">
  <li><a href="/guides/v2.2/contributor-guide/contributing_docs.html">成为贡献者</a>
  <li><a href="https://magento.github.io/glossary/index.html?audience=developer">术语表</a></li>
  <li><a href="http://magento.com/legal/terms/privacy/">隐私政策</a></li>
  <li><a href="http://magento.com/legal/terms/">服务条款</a></li>
  <li><a href="http://magento.com/legal/licensing/">许可/商标 常见问题</a></li>
  <li><a href="/guides/v2.2/release-notes/bk-release-notes.html">版本日志</a></li>
  <li><a href="/magento-third-party.html">三方许可</a></li>
</ul>

    </div>

		<div class="copyright-date">&copy; 2018 Magento. All rights reserved.</div>

  </div>
</div>
<!-- / #footer -->


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="/assets/js/app.min.js"></script>


<script src="/common/js/devdocs.min.js"></script>




</body>
</html>

